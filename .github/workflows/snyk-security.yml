name: Snyk Security Scan MVP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      # 1. Checkout repository
      - uses: actions/checkout@v4

      # ================================
      # Frontend OSS Scan
      # ================================
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Snyk frontend OSS scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=frontend/package.json --sarif-file-output=snyk-frontend-oss.sarif

      # Upload frontend OSS SARIF
      - name: Upload frontend OSS SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-frontend-oss.sarif') != ''
        with:
          sarif_file: snyk-frontend-oss.sarif
          category: snyk-frontend-oss

      # ================================
      # Backend OSS Scan
      # ================================
      - name: Install backend dependencies
        run: npm ci
        working-directory: ./backend

      - name: Snyk backend OSS scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=backend/package.json --sarif-file-output=snyk-backend-oss.sarif

      # Upload backend OSS SARIF
      - name: Upload backend OSS SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-backend-oss.sarif') != ''
        with:
          sarif_file: snyk-backend-oss.sarif
          category: snyk-backend-oss

      # ================================
      # SAST Scan (single scan for repo)
      # ================================
      - name: Snyk SAST scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: code test ./ --sarif-file-output=snyk-code.sarif

      # Upload SAST SARIF
      - name: Upload SAST SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-code.sarif') != ''
        with:
          sarif_file: snyk-code.sarif
          category: snyk-code
