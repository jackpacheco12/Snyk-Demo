name: Snyk Security Scan MVP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]


jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@v4

      # Install frontend dependencies
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      # Run Snyk on frontend
      - name: Snyk frontend scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=frontend/package.json --sarif-file-output=snyk-frontend.sarif

      # Upload frontend SARIF
      - name: Upload frontend SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-frontend.sarif') != ''
        with:
          sarif_file: snyk-frontend.sarif
          category: snyk-frontend

      # Install backend dependencies
      - name: Install backend dependencies
        run: npm ci
        working-directory: ./backend

      # Run Snyk on backend
      - name: Snyk backend scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=backend/package.json --sarif-file-output=snyk-backend.sarif

      # Upload backend SARIF
      - name: Upload backend SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-backend.sarif') != ''
        with:
          sarif_file: snyk-backend.sarif
          category: snyk-backend
