name: Security Scan & Deploy

on:
  push:
    branches: [ main, master, production ]
  pull_request:
    branches: [ main, master, production ]

env:
  ENABLE_SECURITY_SCANS: false  # Set to true to enable security scanning

jobs:
  security-scan:
    runs-on: ubuntu-latest
    if: env.ENABLE_SECURITY_SCANS == 'true'
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      # ================================
      # Frontend Security Scanning
      # ================================
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Snyk frontend vulnerability scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=frontend/package.json --sarif-file-output=frontend-deps.sarif

      - name: Upload frontend security report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('frontend-deps.sarif') != ''
        with:
          sarif_file: frontend-deps.sarif
          category: frontend-deps

      # ================================
      # Backend Security Scanning
      # ================================
      - name: Install backend dependencies
        run: npm ci
        working-directory: ./backend

      - name: Snyk backend vulnerability scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=backend/package.json --sarif-file-output=backend-deps.sarif

      - name: Upload backend security report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('backend-deps.sarif') != ''
        with:
          sarif_file: backend-deps.sarif
          category: backend-deps

      # ================================
      # Code Quality Scan
      # ================================
      - name: Snyk code quality scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          command: code test
          args: --sarif-file-output=code-scan.sarif

      - name: Upload code quality report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('code-scan.sarif') != ''
        with:
          sarif_file: code-scan.sarif
          category: code-scan

      # ================================
      # Infrastructure as Code Scan
      # ================================
      - name: Snyk IaC scan
        uses: snyk/actions/iac@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --sarif-file-output=iac-scan.sarif

      - name: Upload IaC security report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('iac-scan.sarif') != ''
        with:
          sarif_file: iac-scan.sarif
          category: iac-scan

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: security-scan
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/production' &&
      (needs.security-scan.result == 'success' || env.ENABLE_SECURITY_SCANS == 'false')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Build frontend
        run: |
          npm ci
          npm run build
        working-directory: ./frontend

      - name: Test backend startup
        run: |
          npm ci
          timeout 10s npm start || true
        working-directory: ./backend

      # ================================
      # GCP Authentication & Setup
      # ================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # ================================
      # Docker Build & Push
      # ================================
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Build and push Docker images
        run: |
          PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          REGION=${{ secrets.GCP_REGION }}
          REGISTRY_URL="$REGION-docker.pkg.dev/$PROJECT_ID/bookshelf-mvp"

          # Build and push backend
          docker build -t $REGISTRY_URL/bookshelf-backend:latest ./backend
          docker push $REGISTRY_URL/bookshelf-backend:latest

          # Build and push frontend
          docker build -t $REGISTRY_URL/bookshelf-frontend:latest ./frontend
          docker push $REGISTRY_URL/bookshelf-frontend:latest

      # ================================
      # Deploy to GKE
      # ================================
      - name: Deploy to GKE
        run: |
          # Get cluster credentials
          gcloud container clusters get-credentials bookshelf-mvp-cluster \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

          # Update images and deploy
          export USE_REGISTRY=true
          export PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          export GCP_REGION=${{ secrets.GCP_REGION }}
          ./scripts/deploy-app.sh

  container-security-scan:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: |
      env.ENABLE_SECURITY_SCANS == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/production'
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Scan backend container image
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          image: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/bookshelf-mvp/bookshelf-backend:latest
          args: --severity-threshold=high --sarif-file-output=backend-container.sarif

      - name: Upload backend container scan results
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('backend-container.sarif') != ''
        with:
          sarif_file: backend-container.sarif
          category: backend-container

      - name: Scan frontend container image
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          image: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/bookshelf-mvp/bookshelf-frontend:latest
          args: --severity-threshold=high --sarif-file-output=frontend-container.sarif

      - name: Upload frontend container scan results
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('frontend-container.sarif') != ''
        with:
          sarif_file: frontend-container.sarif
          category: frontend-container
