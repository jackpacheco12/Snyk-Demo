name: Snyk Security Scan MVP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      # 1. Checkout repository
      - uses: actions/checkout@v4

      # ================================
      # Frontend OSS Scan
      # ================================
      - name: Snyk frontend OSS scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=frontend/package.json --sarif-file-output=snyk-frontend-oss.sarif

      # Upload frontend OSS SARIF
      - name: Upload frontend OSS SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-frontend-oss.sarif') != ''
        with:
          sarif_file: snyk-frontend-oss.sarif
          category: snyk-frontend-oss

      # ================================
      # Backend OSS Scan
      # ================================
      - name: Snyk backend OSS scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=backend/package.json --sarif-file-output=snyk-backend-oss.sarif

      # Upload backend OSS SARIF
      - name: Upload backend OSS SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-backend-oss.sarif') != ''
        with:
          sarif_file: snyk-backend-oss.sarif
          category: snyk-backend-oss

      # ================================
      # Frontend SAST Scan
      # ================================
      - name: Snyk frontend SAST scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: code test ./frontend --sarif-file-output=snyk-frontend-code.sarif

      # Upload frontend SAST SARIF
      - name: Upload frontend SAST SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-frontend-code.sarif') != ''
        with:
          sarif_file: snyk-frontend-code.sarif
          category: snyk-frontend-code

      # ================================
      # Backend SAST Scan
      # ================================
      - name: Snyk backend SAST scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: code test ./backend --sarif-file-output=snyk-backend-code.sarif

      # Upload backend SAST SARIF
      - name: Upload backend SAST SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-backend-code.sarif') != ''
        with:
          sarif_file: snyk-backend-code.sarif
          category: snyk-backend-code

      # ================================
      # Optional IaC Scan (Terraform / CloudFormation)
      # ================================
      - name: Snyk IaC scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: iac test ./iac --sarif-file-output=snyk-iac.sarif

      # Upload IaC SARIF
      - name: Upload IaC SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('snyk-iac.sarif') != ''
        with:
          sarif_fi_
