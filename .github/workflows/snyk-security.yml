name: Security Scan & Deploy

on:
  push:
    branches: [ main, master, production ]
  pull_request:
    branches: [ main, master, production ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      # ================================
      # Frontend Security Scanning
      # ================================
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Snyk frontend vulnerability scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=frontend/package.json --sarif-file-output=frontend-deps-${{ github.run_id }}.sarif

      - name: Upload frontend security report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('frontend-deps-${{ github.run_id }}.sarif') != ''
        with:
          sarif_file: frontend-deps-${{ github.run_id }}.sarif
          category: frontend-deps-${{ github.run_id }}

      # ================================
      # Backend Security Scanning
      # ================================
      - name: Install backend dependencies
        run: npm ci
        working-directory: ./backend

      - name: Snyk backend vulnerability scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --file=backend/package.json --sarif-file-output=backend-deps-${{ github.run_id }}.sarif

      - name: Upload backend security report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('backend-deps-${{ github.run_id }}.sarif') != ''
        with:
          sarif_file: backend-deps-${{ github.run_id }}.sarif
          category: backend-deps-${{ github.run_id }}

      # ================================
      # Code Quality Scan
      # ================================
      - name: Snyk code quality scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          command: code test
          args: --sarif-file-output=code-scan-${{ github.run_id }}.sarif

      - name: Upload code quality report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('code-scan-${{ github.run_id }}.sarif') != ''
        with:
          sarif_file: code-scan-${{ github.run_id }}.sarif
          category: code-scan-${{ github.run_id }}

      # ================================
      # Infrastructure as Code Scan
      # ================================
      - name: Snyk IaC scan
        uses: snyk/actions/iac@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          args: --sarif-file-output=iac-scan-${{ github.run_id }}.sarif

      - name: Upload IaC security report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('iac-scan-${{ github.run_id }}.sarif') != ''
        with:
          sarif_file: iac-scan-${{ github.run_id }}.sarif
          category: iac-scan-${{ github.run_id }}

      # ================================
      # Container Security Scan
      # ================================
      - name: Build Docker images for scanning
        run: |
          docker build -t bookshelf-backend:scan ./backend
          docker build -t bookshelf-frontend:scan ./frontend

      - name: Snyk container scan - Backend
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          image: bookshelf-backend:scan
          args: --sarif-file-output=backend-container-${{ github.run_id }}.sarif

      - name: Upload backend container security report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('backend-container-${{ github.run_id }}.sarif') != ''
        with:
          sarif_file: backend-container-${{ github.run_id }}.sarif
          category: backend-container-${{ github.run_id }}

      - name: Snyk container scan - Frontend
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_KEY }}
        with:
          image: bookshelf-frontend:scan
          args: --sarif-file-output=frontend-container-${{ github.run_id }}.sarif

      - name: Upload frontend container security report
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('frontend-container-${{ github.run_id }}.sarif') != ''
        with:
          sarif_file: frontend-container-${{ github.run_id }}.sarif
          category: frontend-container-${{ github.run_id }}

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: security-scan
    if: github.event_name == 'push' && github.ref == 'refs/heads/production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Build frontend
        run: |
          npm ci
          npm run build
        working-directory: ./frontend

      - name: Test backend startup
        run: |
          npm ci
          timeout 10s npm start || true
        working-directory: ./backend

      # ================================
      # GCP Authentication & Setup
      # ================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # ================================
      # Docker Build & Push
      # ================================
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Build and push Docker images
        run: |
          PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          REGION=${{ secrets.GCP_REGION }}
          REGISTRY_URL="$REGION-docker.pkg.dev/$PROJECT_ID/bookshelf-mvp"

          # Build and push backend
          docker build -t $REGISTRY_URL/bookshelf-backend:latest ./backend
          docker push $REGISTRY_URL/bookshelf-backend:latest

          # Build and push frontend
          docker build -t $REGISTRY_URL/bookshelf-frontend:latest ./frontend
          docker push $REGISTRY_URL/bookshelf-frontend:latest

      # ================================
      # Deploy to GKE
      # ================================
      - name: Deploy to GKE
        run: |
          # Get cluster credentials
          gcloud container clusters get-credentials bookshelf-mvp-cluster \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

          # Update images and deploy
          export USE_REGISTRY=true
          export PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          export GCP_REGION=${{ secrets.GCP_REGION }}
          ./scripts/deploy-app.sh
